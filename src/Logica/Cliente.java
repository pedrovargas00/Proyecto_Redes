package Logica;
import Controlador.ControladorGrafico;
import java.net.*;
import java.security.*;
import java.io.*;
import java.util.ArrayList;
import javax.crypto.*;

public class Cliente {

    private String usuario;
    private String contrasenia;
    private int login;
    private ArrayList<String> contactos;
    private String contacto;
    private String mensajeEntrante;
    private String mensajeSaliente;
    private String contactoModificar;
    private ControladorGrafico controlador;
    private final ArrayList<String> usuarios;
    private final Cifrado cifrado;
    private final Md5 md5;
    private Socket socket;
    private BufferedReader entrada;
    private PrintWriter salida;

    public Cliente() {

        this.contactos = new ArrayList();
        this.usuarios = new ArrayList();
        this.usuario = "";
        this.contrasenia = "";
        this.contacto = "";
        this.login = -1;
        this.mensajeEntrante = "";
        this.mensajeSaliente = "";
        this.cifrado = new Cifrado();
        this.md5 = new Md5();
    }

    public void setControlador(ControladorGrafico controlador) {

        this.controlador = controlador;
    }

    public String getUsuario() {

        return usuario;
    }

    public void setContactoModificar(String cont){
      this.contactoModificar = cont;
    }

    public String getContactoModificar(){
      return this.contactoModificar;
    }

    public void setUsuario(String usuario) {

        this.usuario = usuario;
        System.out.println("Usuario_" + usuario);
    }

    public String getContrasenia() {

        return contrasenia;
    }

    public void setContacto(String contacto) {

        this.contacto = contacto;
        System.out.println("setContacto "+ this.contacto);
    }

    public void setContrasenia(String contrasenia) {

        this.contrasenia = contrasenia;
        System.out.println("Con: " + contrasenia);
    }

    public int getLogin() {

        return login;
    }

    public void setLogin(final int login) {

        this.login = login;
    }

    public ArrayList<String> getContactos() {

        return contactos;
    }

    public void setContactos(final ArrayList<String> contactos) {

        this.contactos = contactos;
    }

    public ArrayList<String> getUsuarios() {

        return usuarios;
    }

    public String getMensajeEntrante() {

        return mensajeEntrante;
    }

    public void setMensajeEntrante(final String mensajeEntrante) {

        this.mensajeEntrante = mensajeEntrante;
    }

    public String getMensajeSaliente() {

        return mensajeSaliente;
    }

    public void setMensajeSaliente(final String mensajeSaliente) {

        this.mensajeSaliente = mensajeSaliente;
    }

    private static String mezclar(final String messageStr, final String password) {

        final StringBuilder message = new StringBuilder(messageStr);
        for (int i = 0; i < password.length(); i++)
            message.insert((i * 42) + password.charAt(i), password.charAt(i));

        message.insert(0, password.length());
        return message.toString();
    }

    public void menu() throws Exception {
/*
      try {
          Socket socket = new Socket("localhost", 9999);
          BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
          PrintWriter salida = new PrintWriter(new OutputStreamWriter(socket.getOutputStream()), true);
*/
          while (getLogin() != -2) {
              // System.out.print("MENU\n1.- Registro\n2.- Login\n0.- Salir.\n--> ");
              // opcion = in.nextInt();
              System.out.println("Log"+getLogin());
              switch (getLogin()) {
                  case 0:
                      registro();
                      break;
                  case 1:
                      login();
                      break;
                  case 2:
                      System.out.println("Chat");
                      chat();
                      break;
                  case 3:
                      recibirChat();
                      break;
                  case 4:
                      eliminarContacto();
                      break;
                  case 5:
                      // System.out.println("Esperando si se recibe un chat");
                      esperandoRecibir();
                      break;
                  case 6:
                      agregarContacto();
                      break;
                  default:
                      // System.out.println("Opcion invÃ¡lida");
                      System.out.println("");
                      break;
              }
          }
    }

    public void eliminarContacto() throws UnknownHostException, IOException {
        System.out.println("Eliminar Contacto");
        final String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
        try {
            Socket socket = new Socket("localhost", 9999);
            BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintWriter salida = new PrintWriter(new OutputStreamWriter(socket.getOutputStream()), true);
            salida.println(cifrado.cifrar("4", clave));
            salida.println(cifrado.cifrar(getContactoModificar(), clave));
            for(int i=0; i < getContactos().size(); i++)
                if(getContactoModificar().equals(getContactos().get(i)))
                  getContactos().remove(i);
          setLogin(-1);
          socket.close();
        } catch (final UnknownHostException e) {
            e.printStackTrace();
        } catch (final Exception e) {
            e.printStackTrace();
        }
    }

    public void agregarContacto() throws UnknownHostException, IOException {
        System.out.println("agregar Contacto");
        final String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
        try {
            Socket socket = new Socket("localhost", 9999);
            BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintWriter salida = new PrintWriter(new OutputStreamWriter(socket.getOutputStream()), true);
            salida.println(cifrado.cifrar("6", clave));
            salida.println(cifrado.cifrar(getContactoModificar(), clave));
            getContactos().add(getContactoModificar());
          setLogin(-1);
          socket.close();
        } catch (final UnknownHostException e) {
            e.printStackTrace();
        } catch (final Exception e) {
            e.printStackTrace();
        }
    }

    public void esperandoRecibir() throws UnknownHostException, IOException {
        System.out.println("Esperando recibir chat");
        final String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
        try {
            Socket socket = new Socket("localhost", 9999);
            BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintWriter salida = new PrintWriter(new OutputStreamWriter(socket.getOutputStream()), true);
            salida.println(cifrado.cifrar("5", clave));
            String v;
            while(true){
              if ((v = entrada.readLine())=="chat" ){
                  System.out.println("Esperando recibir chat"+v);
                      System.out.println("Recibi un chat");
                      setLogin(3);
                      break;
              }
              if(getLogin() == 2 || getLogin() == 4 || getLogin() == 6)
                break;
            }
          socket.close();
        } catch (final UnknownHostException e) {
            e.printStackTrace();
        } catch (final Exception e) {
            e.printStackTrace();
        }
    }
    public void registro() throws Exception {

      String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
      String entry;
      String datos[] = new String[2];
      try{
          Socket socket = new Socket("localhost", 9999);
          BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
          PrintWriter salida = new PrintWriter( new OutputStreamWriter(socket.getOutputStream() ), true);

          System.out.println("\nRegistro");
          datos[0] = getUsuario();
          datos[1] = getContrasenia();
          System.out.println("--Datos: " + datos[0] + " " + datos[1]);
          salida.println(cifrado.cifrar("0", clave));
          salida.println(cifrado.cifrar(datos[0], clave));
          salida.println(cifrado.cifrar(datos[1], clave));
          //while(true){
              entry = cifrado.descifrar(entrada.readLine(), clave);
              if(entry.equalsIgnoreCase("Ya existe")){
                controlador.registro(false);
                System.out.println("***EL USUARIO YA EXISTE***");
                setLogin(-1);
            //    break;
              } if(entry.equalsIgnoreCase("Agregado")){
                System.out.println("***USUARIO AGREGADO***");
                controlador.registro(true);
                setLogin(-1);
              //  break;
              }
//          }
          socket.close();
      }catch(final UnknownHostException e){
            e.printStackTrace();
      }catch(final IOException e){
            e.printStackTrace();
      }
    }

    public void login() throws Exception {

      String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
      String mensaje = "", mezcla, entry, finalMd5, contacto, usuarioT;
      String datos[] = new String[2];

      try{
          Socket socket = new Socket("localhost", 9999);
          BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
          PrintWriter salida = new PrintWriter( new OutputStreamWriter(socket.getOutputStream() ), true);
          System.out.println("\nLogin");
          datos[0] = getUsuario();
          datos[1] = getContrasenia();
/*          if(!datos[0].isEmpty() && !datos[1].isEmpty()){
            setUsuario("");
            setContrasenia("");*/
            System.out.println("Datos: " + datos[0] + " " + datos[1]);
            salida.println(cifrado.cifrar("1", clave));
            salida.println(cifrado.cifrar(datos[0], clave));
            entry = cifrado.descifrar(entrada.readLine(), clave);
            if(entry.equalsIgnoreCase("1")){
                mensaje = entrada.readLine();
                mezcla = mezclar(mensaje, datos[1]);
                finalMd5 = md5.algoritmoMd5(mezcla);
                salida.println(finalMd5);
                if(cifrado.descifrar(entrada.readLine(), clave).equalsIgnoreCase("9")){
                    if(cifrado.descifrar(entrada.readLine(), clave).equalsIgnoreCase("\n****TIENE ACCESO****")){
                        System.out.println("Acceso permitido");
                        while ((usuarioT = entrada.readLine())!= null)
                            if(!usuarioT.equalsIgnoreCase("-1"))
                              getUsuarios().add(usuarioT);
                            else
                              break;
                        while((contacto = entrada.readLine()) != null)
                            if(!contacto.equalsIgnoreCase("-1"))
                                getContactos().add(contacto);
                            else
                                break;
                        controlador.permitido(true);
                        setLogin(5);
                    }else{
                      controlador.permitido(false);
                      setLogin(-1);
                    }
                }
                setLogin(-1);
            }if(entry.equalsIgnoreCase("-1")){//No recordamos para quÃ© se usa
              controlador.permitido(false);
              setLogin(-1);
            }
      //    }
          setLogin(-1);
          socket.close();
      } catch(final UnknownHostException e){
          e.printStackTrace();
      } catch(final IOException e){
          e.printStackTrace();
      }
    }

    public void chat() throws Exception{

        try{
            Socket socket = new Socket("localhost", 9999);
            BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintWriter salida = new PrintWriter( new OutputStreamWriter(socket.getOutputStream() ), true);
            String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
            String mensaje = " ";
            System.out.println("Nombre del contacto  "+ contacto);
            salida.println(cifrado.cifrar("2", clave));
            salida.println(cifrado.cifrar(contacto, clave));
            while(true){
                if(!mensajeSaliente.isEmpty()){
                    salida.println(mensajeSaliente);
                    setMensajeSaliente(mensajeSaliente);
                    setMensajeSaliente("");
                }
                if(!(mensaje = cifrado.descifrar(entrada.readLine(), clave)).isEmpty()){
                    System.out.println("mensaje Recibido: " + mensaje);
                    setMensajeEntrante(mensaje);
                    setMensajeEntrante("");
                }
                if(mensajeSaliente == "x"||mensaje == "x")
                    break;
            }
            socket.close();
        }catch(final UnknownHostException e){
              e.printStackTrace();
        }catch(final IOException e){
              e.printStackTrace();
        }
        setLogin(5);
    }

    public void recibirChat()throws Exception{

        try{
            final Socket socket = new Socket("localhost", 9999);
            final BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            final PrintWriter salida = new PrintWriter( new OutputStreamWriter(socket.getOutputStream() ), true);
            final String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
            String mensaje = " ";

            controlador.mostrarChat(cifrado.descifrar(entrada.readLine(), clave));
            while(true){
                if(!mensajeSaliente.isEmpty()){
                    salida.println(mensajeSaliente);
                    setMensajeSaliente(mensajeSaliente);
                    setMensajeSaliente("");
                }
                if(!(mensaje = cifrado.descifrar(entrada.readLine(), clave)).isEmpty()){
                    System.out.println("mensaje Recibido: " + mensaje);
                    setMensajeEntrante(mensaje);
                    setMensajeEntrante("");
                }
                if(mensajeSaliente == "x"||mensaje == "x")
                    break;
            }
            socket.close();
        }catch(final UnknownHostException e){
              e.printStackTrace();
        }catch(final IOException e){
              e.printStackTrace();
        }
        setLogin(5);

    }
    /*public void cliente() throws Exception{

        int puerto = 9999;
        boolean accedio = false;
        String servidor = "localhost";
        String clave = "_#::==:/$$$%%%//=/%:&:[fgdg][hjjuuyrf]adwd>>###VVV-V###>>>ghghghg///&&,&";
        String mensaje = "", mezcla, entry, finalMd5, contacto, usuarioT;
        String datos[] = new String[2];


        try{
            Socket socket = new Socket(servidor, puerto);
            BufferedReader entrada = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintWriter salida = new PrintWriter( new OutputStreamWriter(socket.getOutputStream() ), true);
            System.out.println("GetLogin: " + getLogin());
                  //while(login == -1)
                    //  System.out.print("");

          System.out.println("--GetLogin: " + getLogin());

          switch(getLogin()){

              case 0:
                  System.out.println("\nRegistro");
                  datos[0] = getUsuario();
                  datos[1] = getContrasenia();
                  System.out.println("--Datos: " + datos[0] + " " + datos[1]);
                  salida.println(cifrado.cifrar("0", clave));
                  salida.println(cifrado.cifrar(datos[0], clave));
                  salida.println(cifrado.cifrar(datos[1], clave));
                  while(true){
                      entry = cifrado.descifrar(entrada.readLine(), clave);
                      if(entry.equalsIgnoreCase("Ya existe")){
                        controlador.registro(false);
                        System.out.println("***EL USUARIO YA EXISTE***");
                        setLogin(-1);
                        break;
                      } if(entry.equalsIgnoreCase("Agregado")){
                        System.out.println("***USUARIO AGREGADO***");
                        controlador.registro(true);
                        setLogin(-1);
                        break;
                      }
                  }
                  break;

              case 1:
                  System.out.println("\nLogin");
                  datos[0] = getUsuario();
                  datos[1] = getContrasenia();
                  System.out.println("Datos: " + datos[0] + " " + datos[1]);
                  salida.println(cifrado.cifrar("1", clave));
                  salida.println(cifrado.cifrar(datos[0], clave));
                  while(true){
                      entry = cifrado.descifrar(entrada.readLine(), clave);
                      if(entry.equalsIgnoreCase("1")){
                          mensaje = entrada.readLine();
                          mezcla = mezclar(mensaje, datos[1]);
                          finalMd5 = md5.algoritmoMd5(mezcla);
                          salida.println(finalMd5);
                          if(cifrado.descifrar(entrada.readLine(), clave).equalsIgnoreCase("9")){
                              if(cifrado.descifrar(entrada.readLine(), clave).equalsIgnoreCase("\n****TIENE ACCESO****")){
                                  System.out.println("Acceso permitido");

                                  while ((usuarioT = entrada.readLine())!= null)
                                      if(!usuarioT.equalsIgnoreCase("-1"))
                                        getUsuarios().add(usuarioT);
                                      else
                                        break;

                                  while((contacto = entrada.readLine()) != null)
                                      if(!contacto.equalsIgnoreCase("-1"))
                                          getContactos().add(contacto);
                                      else
                                          break;
                                  controlador.permitido(true);
                                  accedio = true;
                              }else{
                                controlador.permitido(false);
                                setLogin(-1);
                              }
                          }
                      }
                      if(entry.equalsIgnoreCase("-1")){//No recordamos para quÃ© se usa
                          controlador.permitido(false);
                          setLogin(-1);
                          break;
                      }
                  }
                  break;
              case -2:
              //Respaldar
                  System.out.println("Saliendo de cliente");
                  salida.println(cifrado.cifrar("-1", clave));
                  break;
              default:
                  break;
          }
            socket.close();
            }
            catch(UnknownHostException e){
                e.printStackTrace();
            }
            catch(IOException e){
                e.printStackTrace();
            }
    }*/
}
